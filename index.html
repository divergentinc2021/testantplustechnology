<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANT+ Device Emulator with Real Broadcasting</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .connection-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .connection-status {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .usb-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e74c3c;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #2ecc71;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .devices-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .device-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .device-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }

        .device-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .device-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            margin-right: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .trainer .device-icon { background: linear-gradient(45deg, #ff6b6b, #ff8e8e); }
        .shifter .device-icon { background: linear-gradient(45deg, #4ecdc4, #45b7aa); }
        .hrm .device-icon { background: linear-gradient(45deg, #a8e6cf, #7fcdcd); }

        .device-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .device-status {
            font-size: 0.9rem;
            color: #7f8c8d;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-active { background-color: #2ecc71; }
        .status-inactive { background-color: #e74c3c; }
        .status-pairing { background-color: #f39c12; animation: pulse 1s infinite; }

        .controls {
            margin-bottom: 20px;
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #34495e;
        }

        .control-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .control-input:focus {
            outline: none;
            border-color: #3498db;
        }

        .btn {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 10px;
        }

        .btn:hover {
            background: linear-gradient(45deg, #2980b9, #1f639a);
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }

        .btn-stop {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
        }

        .btn-stop:hover {
            background: linear-gradient(45deg, #c0392b, #a93226);
        }

        .btn-pair {
            background: linear-gradient(45deg, #f39c12, #e67e22);
        }

        .btn-pair:hover {
            background: linear-gradient(45deg, #e67e22, #d35400);
        }

        .btn-usb {
            background: linear-gradient(45deg, #9b59b6, #8e44ad);
            margin-bottom: 0;
        }

        .btn-usb:hover {
            background: linear-gradient(45deg, #8e44ad, #7d3c98);
        }

        .metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .metric {
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .metric-label {
            font-size: 0.8rem;
            color: #7f8c8d;
            text-transform: uppercase;
        }

        .ant-info {
            background: #ecf0f1;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        .ant-channel {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .log-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .log-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .clear-log {
            background: #95a5a6;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .log-content {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .gear-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
        }

        .gear-display {
            font-size: 2rem;
            font-weight: bold;
            color: #2c3e50;
            background: #ecf0f1;
            padding: 10px 20px;
            border-radius: 10px;
            min-width: 80px;
            text-align: center;
        }

        .gear-btn {
            background: #34495e;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            font-weight: bold;
            transition: all 0.2s ease;
        }

        .gear-btn:hover {
            background: #2c3e50;
            transform: scale(1.1);
        }

        .hr-zone {
            text-align: center;
            margin: 10px 0;
            padding: 8px;
            border-radius: 5px;
            font-weight: bold;
        }

        .zone-1 { background: #e8f5e8; color: #27ae60; }
        .zone-2 { background: #fff3cd; color: #f39c12; }
        .zone-3 { background: #ffeaa7; color: #fdcb6e; }
        .zone-4 { background: #fab1a0; color: #e17055; }
        .zone-5 { background: #fd79a8; color: #e84393; }

        .protocol-info {
            background: #e8f4fd;
            border: 1px solid #3498db;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .protocol-info h3 {
            color: #2980b9;
            margin-bottom: 10px;
        }

        .hex-display {
            font-family: 'Courier New', monospace;
            background: #34495e;
            color: #ecf0f1;
            padding: 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚴‍♂️ ANT+ Device Emulator Pro</h1>
            <p>Real ANT+ Broadcasting with USB Stick Support</p>
        </div>

        <div class="protocol-info">
            <h3>🔗 ANT+ Protocol Broadcasting</h3>
            <p>This emulator broadcasts real ANT+ signals using the Web Serial API. Connect an ANT+ USB stick to transmit signals that can be received by ANT+ devices, apps, and head units.</p>
            <p><strong>Requirements:</strong> ANT+ USB stick (Garmin, Dynastream, etc.) and Chrome/Edge browser with Web Serial API support.</p>
        </div>

        <!-- Connection Panel -->
        <div class="connection-panel">
            <div class="connection-status">
                <div class="usb-status">
                    <div class="status-dot" id="usb-status-dot"></div>
                    <span id="usb-status-text">ANT+ USB Stick: Disconnected</span>
                </div>
                <button class="btn btn-usb" id="connect-btn" onclick="connectANTStick()">Connect ANT+ USB</button>
            </div>
            <div id="ant-stick-info" style="display: none;">
                <strong>Connected Device:</strong> <span id="device-name"></span><br>
                <strong>ANT+ Network Key:</strong> <span class="hex-display" id="network-key">B9 A5 21 FB BD 72 C3 45</span>
            </div>
        </div>

        <div class="devices-grid">
            <!-- Trainer Card -->
            <div class="device-card trainer">
                <div class="device-header">
                    <div class="device-icon">🚴</div>
                    <div>
                        <div class="device-title">Wahoo Kickr Core</div>
                        <div class="device-status">
                            <span class="status-indicator" id="trainer-status"></span>
                            <span id="trainer-status-text">Stopped</span>
                        </div>
                    </div>
                </div>

                <div class="ant-info">
                    <div class="ant-channel">
                        <span>Device Type:</span>
                        <span>FE-C (0x11)</span>
                    </div>
                    <div class="ant-channel">
                        <span>Channel:</span>
                        <span id="trainer-channel">0</span>
                    </div>
                    <div class="ant-channel">
                        <span>Device ID:</span>
                        <span id="trainer-device-id">12345</span>
                    </div>
                    <div class="ant-channel">
                        <span>RF Frequency:</span>
                        <span>2457 MHz</span>
                    </div>
                </div>

                <div class="metrics">
                    <div class="metric">
                        <div class="metric-value" id="power-value">0</div>
                        <div class="metric-label">Power (W)</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="resistance-value">0</div>
                        <div class="metric-label">Resistance (%)</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="cadence-value">0</div>
                        <div class="metric-label">Cadence (RPM)</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="speed-value">0.0</div>
                        <div class="metric-label">Speed (km/h)</div>
                    </div>
                </div>

                <div class="controls">
                    <div class="control-group">
                        <label class="control-label">Target Power (W)</label>
                        <input type="number" class="control-input" id="target-power" value="150" min="0" max="2000">
                    </div>
                    <div class="control-group">
                        <label class="control-label">Resistance (%)</label>
                        <input type="range" class="control-input" id="resistance-slider" min="0" max="100" value="0">
                    </div>
                </div>

                <button class="btn btn-pair" id="trainer-pair-btn" onclick="pairTrainer()" disabled>Pair Device</button>
                <button class="btn" id="trainer-btn" onclick="toggleTrainer()" disabled>Start Trainer</button>
            </div>

            <!-- Shifter Card -->
            <div class="device-card shifter">
                <div class="device-header">
                    <div class="device-icon">⚙️</div>
                    <div>
                        <div class="device-title">Zwift Click</div>
                        <div class="device-status">
                            <span class="status-indicator" id="shifter-status"></span>
                            <span id="shifter-status-text">Stopped</span>
                        </div>
                    </div>
                </div>

                <div class="ant-info">
                    <div class="ant-channel">
                        <span>Device Type:</span>
                        <span>Shifting (0x22)</span>
                    </div>
                    <div class="ant-channel">
                        <span>Channel:</span>
                        <span id="shifter-channel">1</span>
                    </div>
                    <div class="ant-channel">
                        <span>Device ID:</span>
                        <span id="shifter-device-id">23456</span>
                    </div>
                    <div class="ant-channel">
                        <span>RF Frequency:</span>
                        <span>2457 MHz</span>
                    </div>
                </div>

                <div class="gear-indicator">
                    <button class="gear-btn" onclick="shiftDown()">−</button>
                    <div class="gear-display" id="gear-display">1</div>
                    <button class="gear-btn" onclick="shiftUp()">+</button>
                </div>

                <div class="metrics">
                    <div class="metric">
                        <div class="metric-value" id="front-gear">50</div>
                        <div class="metric-label">Front (T)</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="rear-gear">11</div>
                        <div class="metric-label">Rear (T)</div>
                    </div>
                </div>

                <button class="btn btn-pair" id="shifter-pair-btn" onclick="pairShifter()" disabled>Pair Device</button>
                <button class="btn" id="shifter-btn" onclick="toggleShifter()" disabled>Start Shifter</button>
            </div>

            <!-- Heart Rate Monitor Card -->
            <div class="device-card hrm">
                <div class="device-header">
                    <div class="device-icon">❤️</div>
                    <div>
                        <div class="device-title">Heart Rate Monitor</div>
                        <div class="device-status">
                            <span class="status-indicator" id="hrm-status"></span>
                            <span id="hrm-status-text">Stopped</span>
                        </div>
                    </div>
                </div>

                <div class="ant-info">
                    <div class="ant-channel">
                        <span>Device Type:</span>
                        <span>Heart Rate (0x78)</span>
                    </div>
                    <div class="ant-channel">
                        <span>Channel:</span>
                        <span id="hrm-channel">2</span>
                    </div>
                    <div class="ant-channel">
                        <span>Device ID:</span>
                        <span id="hrm-device-id">34567</span>
                    </div>
                    <div class="ant-channel">
                        <span>RF Frequency:</span>
                        <span>2457 MHz</span>
                    </div>
                </div>

                <div class="metrics">
                    <div class="metric">
                        <div class="metric-value" id="hr-value">0</div>
                        <div class="metric-label">BPM</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="hr-avg">0</div>
                        <div class="metric-label">Avg BPM</div>
                    </div>
                </div>

                <div class="hr-zone" id="hr-zone">Zone 1 - Recovery</div>

                <div class="controls">
                    <div class="control-group">
                        <label class="control-label">Base Heart Rate (BPM)</label>
                        <input type="number" class="control-input" id="base-hr" value="65" min="40" max="200">
                    </div>
                    <div class="control-group">
                        <label class="control-label">Max Heart Rate (BPM)</label>
                        <input type="number" class="control-input" id="max-hr" value="185" min="120" max="220">
                    </div>
                </div>

                <button class="btn btn-pair" id="hrm-pair-btn" onclick="pairHRM()" disabled>Pair Device</button>
                <button class="btn" id="hrm-btn" onclick="toggleHRM()" disabled>Start HRM</button>
            </div>
        </div>

        <!-- Log Section -->
        <div class="log-section">
            <div class="log-header">
                <h2 class="log-title">📡 ANT+ Transmission Log</h2>
                <button class="clear-log" onclick="clearLog()">Clear Log</button>
            </div>
            <div class="log-content" id="log-content"></div>
        </div>
    </div>

    <script>
        // ANT+ Protocol Constants
        const ANT_SYNC_BYTE = 0xA4;
        const ANT_MESSAGE_TYPES = {
            ASSIGN_CHANNEL: 0x42,
            CHANNEL_ID: 0x51,
            CHANNEL_PERIOD: 0x43,
            CHANNEL_RF_FREQ: 0x45,
            OPEN_CHANNEL: 0x4B,
            CLOSE_CHANNEL: 0x4C,
            BROADCAST_DATA: 0x4E,
            SET_NETWORK_KEY: 0x46,
            RESET_SYSTEM: 0x4A
        };

        const ANT_DEVICE_TYPES = {
            HEART_RATE: 0x78,
            FEC_TRAINER: 0x11,
            SHIFTING: 0x22
        };

        // Device state
        let antStick = null;
        let isConnected = false;
        let devices = {
            trainer: {
                active: false,
                paired: false,
                channel: 0,
                deviceId: 12345,
                deviceType: ANT_DEVICE_TYPES.FEC_TRAINER,
                power: 0,
                cadence: 0,
                speed: 0,
                resistance: 0,
                targetPower: 150,
                eventCount: 0
            },
            shifter: {
                active: false,
                paired: false,
                channel: 1,
                deviceId: 23456,
                deviceType: ANT_DEVICE_TYPES.SHIFTING,
                gear: 1,
                frontGear: 50,
                rearGear: 11,
                gearRatios: [11, 12, 13, 14, 15, 17, 19, 21, 23, 25, 28, 32],
                eventCount: 0
            },
            hrm: {
                active: false,
                paired: false,
                channel: 2,
                deviceId: 34567,
                deviceType: ANT_DEVICE_TYPES.HEART_RATE,
                heartRate: 0,
                baseHR: 65,
                maxHR: 185,
                avgHR: 0,
                hrHistory: [],
                eventCount: 0,
                beatTime: 0
            }
        };

        let intervals = {};

        // ANT+ Functions
        async function connectANTStick() {
            if (!('serial' in navigator)) {
                alert('Web Serial API not supported. Please use Chrome or Edge browser.');
                return;
            }

            try {
                const port = await navigator.serial.requestPort();
                await port.open({ baudRate: 57600 });

                antStick = port;
                isConnected = true;
                
                updateConnectionStatus(true);
                
                // Initialize ANT+ stick
                await initializeANTStick();
                
                log('✅ ANT+ USB stick connected successfully');
                log('🔧 Initializing ANT+ protocol...');
                
                // Enable device buttons
                enableDeviceControls();
                
            } catch (error) {
                log(`❌ Failed to connect ANT+ stick: ${error.message}`);
                updateConnectionStatus(false);
            }
        }

        async function initializeANTStick() {
            try {
                // Reset ANT+ stick
                await sendANTMessage(ANT_MESSAGE_TYPES.RESET_SYSTEM, []);
                await sleep(500);

                // Set network key (ANT+ Sport key)
                const networkKey = [0xB9, 0xA5, 0x21, 0xFB, 0xBD, 0x72, 0xC3, 0x45];
                await sendANTMessage(ANT_MESSAGE_TYPES.SET_NETWORK_KEY, [0x00, ...networkKey]);
                
                log('🗝️ ANT+ network key set');
                
            } catch (error) {
                log(`❌ ANT+ initialization failed: ${error.message}`);
            }
        }

        async function sendANTMessage(messageType, data) {
            if (!antStick) return;

            const length = data.length;
            const message = [ANT_SYNC_BYTE, length, messageType, ...data];
            
            // Calculate checksum
            let checksum = 0;
            for (let i = 0; i < message.length; i++) {
                checksum ^= message[i];
            }
            message.push(checksum);

            const writer = antStick.writable.getWriter();
            await writer.write(new Uint8Array(message));
            writer.releaseLock();

            // Log hex representation
            const hexMessage = message.map(b => b.toString(16).padStart(2, '0').toUpperCase()).join(' ');
            log(`📤 TX: ${hexMessage}`);
        }

        async function setupChannel(device) {
            try {
                const { channel, deviceType, deviceId } = devices[device];
                
                // Assign channel
                await sendANTMessage(ANT_MESSAGE_TYPES.ASSIGN_CHANNEL, [channel, 0x10, 0x00]);
                await sleep(50);

                // Set channel ID
                const deviceIdLow = deviceId & 0xFF;
                const deviceIdHigh = (deviceId >> 8) & 0xFF;
                await sendANTMessage(ANT_MESSAGE_TYPES.CHANNEL_ID, [channel, deviceIdLow, deviceIdHigh, deviceType, 0x00]);
                await sleep(50);

                // Set channel period (depends on device type)
                let period;
                if (deviceType === ANT_DEVICE_TYPES.HEART_RATE) {
                    period = 8070; // ~4Hz
                } else if (deviceType === ANT_DEVICE_TYPES.FEC_TRAINER) {
                    period = 8192; // ~4Hz
                } else {
                    period = 8192; // Default
                }
                
                const periodLow = period & 0xFF;
                const periodHigh = (period >> 8) & 0xFF;
                await sendANTMessage(ANT_MESSAGE_TYPES.CHANNEL_PERIOD, [channel, periodLow, periodHigh]);
                await sleep(50);

                // Set RF frequency (2457 MHz = 57)
                await sendANTMessage(ANT_MESSAGE_TYPES.CHANNEL_RF_FREQ, [channel, 57]);
                await sleep(50);

                // Open channel
                await sendANTMessage(ANT_MESSAGE_TYPES.OPEN_CHANNEL, [channel]);
                await sleep(50);

                devices[device].paired = true;
                updateDeviceStatus(device, 'paired');
                log(`📡 ${device.toUpperCase()}: Channel ${channel} opened and ready`);

            } catch (error) {
                log(`❌ ${device.toUpperCase()}: Channel setup failed - ${error.message}`);
            }
        }

        async function broadcastDeviceData(device) {
            if (!devices[device].paired) return;

            let payload = [];
            const deviceData = devices[device];

            switch (device) {
                case 'trainer':
                    // FE-C General Data Page (0x10)
                    payload = [
                        0x10, // Data page 0x10
                        deviceData.eventCount & 0xFF,
                        Math.round(deviceData.cadence) & 0xFF,
                        Math.round(deviceData.power) & 0xFF,
                        (Math.round(deviceData.power) >> 8) & 0xFF,
                        0xFF, // Reserved
                        0xFF, // Reserved
                        0xFF  // Reserved
                    ];
                    deviceData.eventCount++;
                    break;

                case 'shifter':
                    // Shifting Data Page
                    payload = [
                        0x22, // Data page 0x22
                        deviceData.eventCount & 0xFF,
                        deviceData.gear & 0xFF,
                        deviceData.frontGear & 0xFF,
                        deviceData.rearGear & 0xFF,
                        0xFF, // Reserved
                        0xFF, // Reserved
                        0xFF  // Reserved
                    ];
                    break;

                case 'hrm':
                    // Heart Rate Data Page
                    const currentTime = Date.now();
                    if (currentTime - deviceData.beatTime > (60000 / Math.max(deviceData.heartRate, 1))) {
                        deviceData.eventCount++;
                        deviceData.beatTime = currentTime;
                    }
                    
                    payload = [
                        0x00, // Data page 0x00
                        0xFF, // Reserved
                        0xFF, // Reserved
                        0xFF, // Reserved
                        deviceData.eventCount & 0xFF,
                        (deviceData.eventCount >> 8) & 0xFF,
                        Math.round(deviceData.heartRate) & 0xFF,
                        0x00  // Reserved
                    ];
                    break;
            }

            await sendANTMessage(ANT_MESSAGE_TYPES.BROADCAST_DATA, [deviceData.channel, ...payload]);
        }

        function updateConnectionStatus(connected) {
            const statusDot = document.getElementById('usb-status-dot');
            const statusText = document.getElementById('usb-status-text');
            const connectBtn = document.getElementById('connect-btn');
            const antInfo = document.getElementById('ant-stick-info');

            if (connected) {
                statusDot.classList.add('connected');
                statusText.textContent = 'ANT+ USB Stick: Connected';
                connectBtn.textContent = 'Disconnect';
                connectBtn.onclick = disconnectANTStick;
                antInfo.style.display = 'block';
            } else {
                statusDot.classList.remove('connected');
                statusText.textContent = 'ANT+ USB Stick: Disconnected';
                connectBtn.textContent = 'Connect ANT+ USB';
                connectBtn.onclick = connectANTStick;
                antInfo.style.display = 'none';
            }
        }

        async function disconnectANTStick() {
            if (antStick) {
                try {
                    // Stop all devices
                    Object.keys(devices).forEach(device => {
                        if (devices[device].active) {
                            devices[device].active = false;
                            clearInterval(intervals[device]);
                            updateDeviceStatus(device, 'inactive');
                        }
                    });

                    await antStick.close();
                    antStick = null;
                    isConnected = false;
                    updateConnectionStatus(false);
                    disableDeviceControls();
                    log('🔌 ANT+ USB stick disconnected');
                } catch (error) {
                    log(`❌ Disconnect error: ${error.message}`);
                }
            }
        }

        function enableDeviceControls() {
            ['trainer', 'shifter', 'hrm'].forEach(device => {
                document.getElementById(`${device}-pair-btn`).disabled = false;
            });
        }

        function disableDeviceControls() {
            ['trainer', 'shifter', 'hrm'].forEach(device => {
                document.getElementById(`${device}-pair-btn`).disabled = true;
                document.getElementById(`${device}-btn`).disabled = true;
                devices[device].paired = false;
            });
        }

        // Device Control Functions
        async function pairTrainer() {
            updateDeviceStatus('trainer', 'pairing');
            await setupChannel('trainer');
            document.getElementById('trainer-btn').disabled = false;
        }

        async function pairShifter() {
            updateDeviceStatus('shifter', 'pairing');
            await setupChannel('shifter');
            document.getElementById('shifter-btn').disabled = false;
        }

        async function pairHRM() {
            updateDeviceStatus('hrm', 'pairing');
            await setupChannel('hrm');
            document.getElementById('hrm-btn').disabled = false;
        }

        async function toggleTrainer() {
            const btn = document.getElementById('trainer-btn');
            
            if (devices.trainer.active) {
                devices.trainer.active = false;
                clearInterval(intervals.trainer);
                btn.textContent = 'Start Trainer';
                btn.className = 'btn';
                updateDeviceStatus('trainer', 'paired');
                log('🚴 Trainer broadcasting stopped');
            } else {
                devices.trainer.active = true;
                devices.trainer.targetPower = parseInt(document.getElementById('target-power').value);
                btn.textContent = 'Stop Trainer';
                btn.className = 'btn btn-stop';
                updateDeviceStatus('trainer', 'active');
                log(`🚴 Trainer broadcasting started`);
                startTrainerBroadcast();
            }
        }

        function startTrainerBroadcast() {
            intervals.trainer = setInterval(async () => {
                // Simulate realistic trainer behavior
                const targetPower = parseInt(document.getElementById('target-power').value);
                const resistance = parseInt(document.getElementById('resistance-slider').value);
                
                devices.trainer.power = Math.max(0, targetPower + (Math.random() - 0.5) * 20);
                devices.trainer.cadence = Math.max(0, 60 + (devices.trainer.power / 10) + (Math.random() - 0.5) * 10);
                devices.trainer.speed = (devices.trainer.power / 10) + (Math.random() * 2);
                devices.trainer.resistance = resistance;
                
                // Update UI
                document.getElementById('power-value').textContent = Math.round(devices.trainer.power);
                document.getElementById('cadence-value').textContent = Math.round(devices.trainer.cadence);
                document.getElementById('speed-value').textContent = devices.trainer.speed.toFixed(1);
                document.getElementById('resistance-value').textContent = resistance;
                
                // Broadcast ANT+ data
                await broadcastDeviceData('trainer');
            }, 250);
        }

        async function toggleShifter() {
            const btn = document.getElementById('shifter-btn');
            
            if (devices.shifter.active) {
                devices.shifter.active = false;
                btn.textContent = 'Start Shifter';
                btn.className = 'btn';
                updateDeviceStatus('shifter', 'paired');
                log('⚙️ Shifter broadcasting stopped');
            } else {
                devices.shifter.active = true;
                btn.textContent = 'Stop Shifter';
                btn.className = 'btn btn-stop';
                updateDeviceStatus('shifter', 'active');
                log('⚙️ Shifter broadcasting started');
            }
        }

        async function shiftUp() {
            if (devices.shifter.gear < devices.shifter.gearRatios.length) {
                devices.shifter.gear++;
                updateGearDisplay();
                if (devices.shifter.active) {
                    devices.shifter.eventCount++;
                    await broadcastDeviceData('shifter');
                    log(`⚙️ Shift UP: Gear ${devices.shifter.gear}`);
                }
            }
        }

        async function shiftDown() {
            if (devices.shifter.gear > 1) {
                devices.shifter.gear--;
                updateGearDisplay();
                if (devices.shifter.active) {
                    devices.shifter.eventCount++;
                    await broadcastDeviceData('shifter');
                    log(`⚙️ Shift DOWN: Gear ${devices.shifter.gear}`);
                }
            }
        }

        function updateGearDisplay() {
            const gear = devices.shifter.gear;
            const rearTeeth = devices.shifter.gearRatios[gear - 1];
            devices.shifter.rearGear = rearTeeth;
            
            document.getElementById('gear-display').textContent = gear;
            document.getElementById('rear-gear').textContent = rearTeeth;
        }

        async function toggleHRM() {
            const btn = document.getElementById('hrm-btn');
            
            if (devices.hrm.active) {
                devices.hrm.active = false;
                clearInterval(intervals.hrm);
                btn.textContent = 'Start HRM';
                btn.className = 'btn';
                updateDeviceStatus('hrm', 'paired');
                devices.hrm.hrHistory = [];
                log('❤️ Heart Rate Monitor broadcasting stopped');
            } else {
                devices.hrm.active = true;
                devices.hrm.baseHR = parseInt(document.getElementById('base-hr').value);
                devices.hrm.maxHR = parseInt(document.getElementById('max-hr').value);
                btn.textContent = 'Stop HRM';
                btn.className = 'btn btn-stop';
                updateDeviceStatus('hrm', 'active');
                log('❤️ Heart Rate Monitor broadcasting started');
                startHRMBroadcast();
            }
        }

        function startHRMBroadcast() {
            intervals.hrm = setInterval(async () => {
                let targetHR = devices.hrm.baseHR;
                
                if (devices.trainer.active && devices.trainer.power > 0) {
                    const powerPercent = Math.min(devices.trainer.power / 300, 1);
                    targetHR = devices.hrm.baseHR + (devices.hrm.maxHR - devices.hrm.baseHR) * powerPercent;
                }
                
                devices.hrm.heartRate = Math.max(40, targetHR + (Math.random() - 0.5) * 10);
                
                devices.hrm.hrHistory.push(devices.hrm.heartRate);
                if (devices.hrm.hrHistory.length > 20) {
                    devices.hrm.hrHistory.shift();
                }
                devices.hrm.avgHR = devices.hrm.hrHistory.reduce((a, b) => a + b, 0) / devices.hrm.hrHistory.length;
                
                document.getElementById('hr-value').textContent = Math.round(devices.hrm.heartRate);
                document.getElementById('hr-avg').textContent = Math.round(devices.hrm.avgHR);
                updateHRZone();
                
                await broadcastDeviceData('hrm');
            }, 1000);
        }

        function updateHRZone() {
            const hr = devices.hrm.heartRate;
            const maxHR = devices.hrm.maxHR;
            const zoneElement = document.getElementById('hr-zone');
            
            const zones = [
                { max: 0.6, name: 'Zone 1 - Recovery', class: 'zone-1' },
                { max: 0.7, name: 'Zone 2 - Aerobic Base', class: 'zone-2' },
                { max: 0.8, name: 'Zone 3 - Aerobic', class: 'zone-3' },
                { max: 0.9, name: 'Zone 4 - Threshold', class: 'zone-4' },
                { max: 1.0, name: 'Zone 5 - VO2 Max', class: 'zone-5' }
            ];
            
            const hrPercent = hr / maxHR;
            let currentZone = zones[zones.length - 1];
            
            for (let zone of zones) {
                if (hrPercent <= zone.max) {
                    currentZone = zone;
                    break;
                }
            }
            
            zoneElement.textContent = currentZone.name;
            zoneElement.className = `hr-zone ${currentZone.class}`;
        }

        function updateDeviceStatus(device, status) {
            const statusIndicator = document.getElementById(`${device}-status`);
            const statusText = document.getElementById(`${device}-status-text`);
            
            switch (status) {
                case 'active':
                    statusIndicator.className = 'status-indicator status-active';
                    statusText.textContent = 'Broadcasting';
                    break;
                case 'paired':
                    statusIndicator.className = 'status-indicator status-active';
                    statusText.textContent = 'Paired';
                    break;
                case 'pairing':
                    statusIndicator.className = 'status-indicator status-pairing';
                    statusText.textContent = 'Pairing...';
                    break;
                case 'inactive':
                default:
                    statusIndicator.className = 'status-indicator status-inactive';
                    statusText.textContent = 'Stopped';
                    break;
            }
        }

        // Utility functions
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function log(message) {
            const logContent = document.getElementById('log-content');
            const timestamp = new Date().toLocaleTimeString();
            logContent.textContent += `[${timestamp}] ${message}\n`;
            logContent.scrollTop = logContent.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log-content').textContent = '';
        }

        // Initialize
        updateConnectionStatus(false);
        updateGearDisplay();

        // Update resistance display
        document.getElementById('resistance-slider').addEventListener('input', function() {
            document.getElementById('resistance-value').textContent = this.value;
        });

        log('🚀 ANT+ Device Emulator Pro initialized');
        log('📱 Connect ANT+ USB stick to begin broadcasting real signals');
        
        // Check for Web Serial API support
        if (!('serial' in navigator)) {
            log('⚠️ Web Serial API not supported. Please use Chrome or Edge browser.');
        }
    </script>
</body>
</html>