<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Realistic ANT+ Device Emulator Suite</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .connection-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .connection-status {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .usb-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e74c3c;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #2ecc71;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .devices-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .device-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .device-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }

        .device-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .device-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            margin-right: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .trainer .device-icon { background: linear-gradient(45deg, #ff6b6b, #ff8e8e); }
        .shifter .device-icon { background: linear-gradient(45deg, #4ecdc4, #45b7aa); }
        .hrm .device-icon { background: linear-gradient(45deg, #a8e6cf, #7fcdcd); }

        .device-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .device-status {
            font-size: 0.9rem;
            color: #7f8c8d;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-active { background-color: #2ecc71; }
        .status-inactive { background-color: #e74c3c; }
        .status-pairing { background-color: #f39c12; animation: pulse 1s infinite; }

        .ant-info {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }

        .ant-channel {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .metric {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .metric.updated {
            background: #d4edda;
            transform: scale(1.05);
        }

        .metric-value {
            font-size: 1.6rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .metric-label {
            font-size: 0.7rem;
            color: #7f8c8d;
            text-transform: uppercase;
        }

        .controls {
            margin-bottom: 20px;
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #34495e;
        }

        .control-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .control-input:focus {
            outline: none;
            border-color: #3498db;
        }

        .resistance-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }

        .resistance-btn {
            background: #34495e;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s ease;
            min-width: 60px;
        }

        .resistance-btn:hover {
            background: #2c3e50;
            transform: scale(1.05);
        }

        .btn {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 10px;
        }

        .btn:hover {
            background: linear-gradient(45deg, #2980b9, #1f639a);
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }

        .btn-stop {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
        }

        .btn-stop:hover {
            background: linear-gradient(45deg, #c0392b, #a93226);
        }

        .btn-pair {
            background: linear-gradient(45deg, #f39c12, #e67e22);
        }

        .btn-pair:hover {
            background: linear-gradient(45deg, #e67e22, #d35400);
        }

        .btn-usb {
            background: linear-gradient(45deg, #9b59b6, #8e44ad);
            margin-bottom: 0;
        }

        .btn-usb:hover {
            background: linear-gradient(45deg, #8e44ad, #7d3c98);
        }

        .gear-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }

        .gear-display {
            font-size: 3rem;
            font-weight: bold;
            color: #2c3e50;
            background: #ecf0f1;
            padding: 15px 25px;
            border-radius: 15px;
            min-width: 100px;
            text-align: center;
            border: 3px solid #bdc3c7;
            transition: all 0.3s ease;
        }

        .gear-display.updated {
            border-color: #3498db;
            background: #e3f2fd;
            transform: scale(1.1);
        }

        .gear-btn {
            background: #34495e;
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5rem;
            font-weight: bold;
            transition: all 0.2s ease;
        }

        .gear-btn:hover {
            background: #2c3e50;
            transform: scale(1.1);
        }

        .gear-btn:active {
            transform: scale(0.95);
        }

        .hr-zone {
            text-align: center;
            margin: 15px 0;
            padding: 12px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }

        .zone-1 { background: #e8f5e8; color: #27ae60; }
        .zone-2 { background: #fff3cd; color: #f39c12; }
        .zone-3 { background: #ffeaa7; color: #fdcb6e; }
        .zone-4 { background: #fab1a0; color: #e17055; }
        .zone-5 { background: #fd79a8; color: #e84393; }

        .log-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .log-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .clear-log {
            background: #95a5a6;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .log-content {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .hex-display {
            font-family: 'Courier New', monospace;
            background: #34495e;
            color: #ecf0f1;
            padding: 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin: 5px 0;
        }

        .protocol-info {
            background: #e8f4fd;
            border: 1px solid #3498db;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .protocol-info h3 {
            color: #2980b9;
            margin-bottom: 10px;
        }

        .trainer-mode {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .trainer-mode h4 {
            color: #856404;
            margin-bottom: 10px;
        }

        .mode-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .mode-btn {
            padding: 10px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            text-align: center;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .mode-btn.active {
            border-color: #3498db;
            background: #e3f2fd;
            color: #2980b9;
        }

        .mode-btn:hover {
            border-color: #3498db;
        }

        .hr-simulation {
            background: #fdf2f2;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .hr-simulation h4 {
            color: #721c24;
            margin-bottom: 10px;
        }

        .shifter-settings {
            background: #e8f5e8;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .shifter-settings h4 {
            color: #155724;
            margin-bottom: 10px;
        }

        .cassette-display {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 5px;
            margin: 10px 0;
        }

        .cassette-gear {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 3px;
            padding: 5px;
            text-align: center;
            font-size: 0.8rem;
            transition: all 0.2s ease;
        }

        .cassette-gear.active {
            background: #28a745;
            color: white;
            border-color: #28a745;
            transform: scale(1.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üö¥‚Äç‚ôÇÔ∏è Realistic ANT+ Device Emulator Suite</h1>
            <p>Wahoo Kickr Core + Zwift Click + Heart Rate Monitor</p>
        </div>

        <div class="protocol-info">
            <h3>üîó Multi-Device ANT+ Broadcasting</h3>
            <p>This emulator broadcasts authentic signals from three devices simultaneously: Wahoo Kickr Core (FE-C), Zwift Click (Shifting), and Heart Rate Monitor. Each device uses proper ANT+ protocols and realistic behavior patterns.</p>
            <p><strong>Features:</strong> Multiple channel management, authentic device identification, realistic data simulation, and proper protocol timing.</p>
        </div>

        <!-- Connection Panel -->
        <div class="connection-panel">
            <div class="connection-status">
                <div class="usb-status">
                    <div class="status-dot" id="usb-status-dot"></div>
                    <span id="usb-status-text">ANT+ USB Stick: Disconnected</span>
                </div>
                <button class="btn btn-usb" id="connect-btn" onclick="connectANTStick()">Connect ANT+ USB</button>
            </div>
            <div id="ant-stick-info" style="display: none;">
                <strong>Connected Device:</strong> <span id="device-name">ANT+ USB Stick</span><br>
                <strong>ANT+ Network Key:</strong> <span class="hex-display" id="network-key">B9 A5 21 FB BD 72 C3 45</span><br>
                <strong>Active Channels:</strong> <span id="active-channels">0, 1, 2</span>
            </div>
        </div>

        <div class="devices-grid">
            <!-- Wahoo Kickr Core Card -->
            <div class="device-card trainer">
                <div class="device-header">
                    <div class="device-icon">üö¥</div>
                    <div>
                        <div class="device-title">Wahoo Kickr Core</div>
                        <div class="device-status">
                            <span class="status-indicator" id="trainer-status"></span>
                            <span id="trainer-status-text">Stopped</span>
                        </div>
                    </div>
                </div>

                <div class="ant-info">
                    <div class="ant-channel">
                        <span>Device Type:</span>
                        <span>FE-C (0x11)</span>
                    </div>
                    <div class="ant-channel">
                        <span>Channel:</span>
                        <span>0</span>
                    </div>
                    <div class="ant-channel">
                        <span>Device ID:</span>
                        <span>12345</span>
                    </div>
                    <div class="ant-channel">
                        <span>Manufacturer:</span>
                        <span>Wahoo (0x0020)</span>
                    </div>
                    <div class="ant-channel">
                        <span>Product:</span>
                        <span>KICKR CORE (0x0109)</span>
                    </div>
                </div>

                <div class="trainer-mode">
                    <h4>üéØ Trainer Mode</h4>
                    <div class="mode-buttons">
                        <div class="mode-btn active" id="erg-mode" onclick="setTrainerMode('erg')">ERG Mode</div>
                        <div class="mode-btn" id="resistance-mode" onclick="setTrainerMode('resistance')">Resistance</div>
                        <div class="mode-btn" id="simulation-mode" onclick="setTrainerMode('simulation')">Simulation</div>
                    </div>
                </div>

                <div class="metrics">
                    <div class="metric" id="power-metric">
                        <div class="metric-value" id="power-value">0</div>
                        <div class="metric-label">Power (W)</div>
                    </div>
                    <div class="metric" id="cadence-metric">
                        <div class="metric-value" id="cadence-value">0</div>
                        <div class="metric-label">Cadence (RPM)</div>
                    </div>
                    <div class="metric" id="speed-metric">
                        <div class="metric-value" id="speed-value">0.0</div>
                        <div class="metric-label">Speed (km/h)</div>
                    </div>
                    <div class="metric" id="resistance-metric">
                        <div class="metric-value" id="resistance-value">0</div>
                        <div class="metric-label">Resistance (%)</div>
                    </div>
                    <div class="metric" id="distance-metric">
                        <div class="metric-value" id="distance-value">0.00</div>
                        <div class="metric-label">Distance (km)</div>
                    </div>
                    <div class="metric" id="time-metric">
                        <div class="metric-value" id="time-value">00:00:00</div>
                        <div class="metric-label">Time</div>
                    </div>
                </div>

                <div class="controls">
                    <div class="control-group" id="erg-controls">
                        <label class="control-label">Target Power (W)</label>
                        <input type="number" class="control-input" id="target-power" value="150" min="0" max="2000" onchange="updateTargetPower()">
                    </div>
                    
                    <div class="control-group" id="resistance-controls" style="display: none;">
                        <label class="control-label">Resistance Level (%)</label>
                        <div class="resistance-controls">
                            <button class="resistance-btn" onclick="adjustResistance(-10)">-10%</button>
                            <input type="range" class="control-input" id="resistance-slider" min="0" max="100" value="0" style="flex: 1;" onchange="updateResistance()">
                            <button class="resistance-btn" onclick="adjustResistance(10)">+10%</button>
                        </div>
                    </div>

                    <div class="control-group" id="simulation-controls" style="display: none;">
                        <label class="control-label">Grade (%)</label>
                        <input type="number" class="control-input" id="grade-input" value="0" min="-20" max="20" step="0.5" onchange="updateGrade()">
                    </div>

                    <div class="control-group">
                        <label class="control-label">Simulated Cadence (RPM)</label>
                        <input type="number" class="control-input" id="simulated-cadence" value="85" min="0" max="150" onchange="updateCadence()">
                    </div>
                </div>

                <button class="btn btn-pair" id="trainer-pair-btn" onclick="pairTrainer()" disabled>Pair Device</button>
                <button class="btn" id="trainer-btn" onclick="toggleTrainer()" disabled>Start Broadcasting</button>
            </div>

            <!-- Zwift Click Card -->
            <div class="device-card shifter">
                <div class="device-header">
                    <div class="device-icon">‚öôÔ∏è</div>
                    <div>
                        <div class="device-title">Zwift Click</div>
                        <div class="device-status">
                            <span class="status-indicator" id="shifter-status"></span>
                            <span id="shifter-status-text">Stopped</span>
                        </div>
                    </div>
                </div>

                <div class="ant-info">
                    <div class="ant-channel">
                        <span>Device Type:</span>
                        <span>Shifting (0x22)</span>
                    </div>
                    <div class="ant-channel">
                        <span>Channel:</span>
                        <span>1</span>
                    </div>
                    <div class="ant-channel">
                        <span>Device ID:</span>
                        <span>23456</span>
                    </div>
                    <div class="ant-channel">
                        <span>Manufacturer:</span>
                        <span>Zwift (0x0347)</span>
                    </div>
                    <div class="ant-channel">
                        <span>Product:</span>
                        <span>Click (0x0001)</span>
                    </div>
                </div>

                <div class="shifter-settings">
                    <h4>‚öôÔ∏è Drivetrain Setup</h4>
                    <div class="control-group">
                        <label class="control-label">Chainrings</label>
                        <input type="text" class="control-input" id="chainrings" value="50,34" onchange="updateChainrings()">
                    </div>
                    <div class="control-group">
                        <label class="control-label">Cassette</label>
                        <input type="text" class="control-input" id="cassette" value="11,12,13,14,15,17,19,21,23,25,28,32" onchange="updateCassette()">
                    </div>
                </div>

                <div class="gear-indicator">
                    <button class="gear-btn" onclick="shiftDown()">‚àí</button>
                    <div class="gear-display" id="gear-display">6</div>
                    <button class="gear-btn" onclick="shiftUp()">+</button>
                </div>

                <div class="cassette-display" id="cassette-display"></div>

                <div class="metrics">
                    <div class="metric">
                        <div class="metric-value" id="front-gear">50</div>
                        <div class="metric-label">Front (T)</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="rear-gear">17</div>
                        <div class="metric-label">Rear (T)</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="gear-ratio">2.94</div>
                        <div class="metric-label">Ratio</div>
                    </div>
                </div>

                <button class="btn btn-pair" id="shifter-pair-btn" onclick="pairShifter()" disabled>Pair Device</button>
                <button class="btn" id="shifter-btn" onclick="toggleShifter()" disabled>Start Broadcasting</button>
            </div>

            <!-- Heart Rate Monitor Card -->
            <div class="device-card hrm">
                <div class="device-header">
                    <div class="device-icon">‚ù§Ô∏è</div>
                    <div>
                        <div class="device-title">Heart Rate Monitor</div>
                        <div class="device-status">
                            <span class="status-indicator" id="hrm-status"></span>
                            <span id="hrm-status-text">Stopped</span>
                        </div>
                    </div>
                </div>

                <div class="ant-info">
                    <div class="ant-channel">
                        <span>Device Type:</span>
                        <span>Heart Rate (0x78)</span>
                    </div>
                    <div class="ant-channel">
                        <span>Channel:</span>
                        <span>2</span>
                    </div>
                    <div class="ant-channel">
                        <span>Device ID:</span>
                        <span>34567</span>
                    </div>
                    <div class="ant-channel">
                        <span>Manufacturer:</span>
                        <span>Garmin (0x000F)</span>
                    </div>
                    <div class="ant-channel">
                        <span>Product:</span>
                        <span>HRM-Pro (0x0005)</span>
                    </div>
                </div>

                <div class="hr-simulation">
                    <h4>‚ù§Ô∏è HR Simulation Mode</h4>
                    <div class="mode-buttons">
                        <div class="mode-btn active" id="hr-manual-mode" onclick="setHRMode('manual')">Manual</div>
                        <div class="mode-btn" id="hr-auto-mode" onclick="setHRMode('auto')">Auto</div>
                        <div class="mode-btn" id="hr-zones-mode" onclick="setHRMode('zones')">Zones</div>
                    </div>
                </div>

                <div class="metrics">
                    <div class="metric" id="hr-metric">
                        <div class="metric-value" id="hr-value">0</div>
                        <div class="metric-label">BPM</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="hr-avg">0</div>
                        <div class="metric-label">Avg BPM</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="hr-max">0</div>
                        <div class="metric-label">Max BPM</div>
                    </div>
                </div>

                <div class="hr-zone" id="hr-zone">Zone 1 - Recovery</div>

                <div class="controls">
                    <div class="control-group" id="hr-manual-controls">
                        <label class="control-label">Current Heart Rate (BPM)</label>
                        <input type="number" class="control-input" id="manual-hr" value="85" min="40" max="220" onchange="updateManualHR()">
                    </div>
                    
                    <div class="control-group" id="hr-auto-controls" style="display: none;">
                        <label class="control-label">Base Heart Rate (BPM)</label>
                        <input type="number" class="control-input" id="base-hr" value="65" min="40" max="200" onchange="updateBaseHR()">
                        <label class="control-label">Max Heart Rate (BPM)</label>
                        <input type="number" class="control-input" id="max-hr-input" value="185" min="120" max="220" onchange="updateMaxHR()">
                    </div>

                    <div class="control-group" id="hr-zones-controls" style="display: none;">
                        <label class="control-label">Target Zone</label>
                        <select class="control-input" id="target-zone" onchange="updateTargetZone()">
                            <option value="1">Zone 1 - Recovery (50-60%)</option>
                            <option value="2">Zone 2 - Aerobic Base (60-70%)</option>
                            <option value="3">Zone 3 - Aerobic (70-80%)</option>
                            <option value="4">Zone 4 - Threshold (80-90%)</option>
                            <option value="5">Zone 5 - VO2 Max (90-100%)</option>
                        </select>
                    </div>
                </div>

                <button class="btn btn-pair" id="hrm-pair-btn" onclick="pairHRM()" disabled>Pair Device</button>
                <button class="btn" id="hrm-btn" onclick="toggleHRM()" disabled>Start Broadcasting</button>
            </div>
        </div>

        <!-- Log Section -->
        <div class="log-section">
            <div class="log-header">
                <h2 class="log-title">üì° Multi-Device ANT+ Transmission Log</h2>
                <button class="clear-log" onclick="clearLog()">Clear Log</button>
            </div>
            <div class="log-content" id="log-content"></div>
        </div>
    </div>

    <script>
        // ANT+ Protocol Constants
        const ANT_SYNC_BYTE = 0xA4;
        const ANT_MESSAGE_TYPES = {
            ASSIGN_CHANNEL: 0x42,
            CHANNEL_ID: 0x51,
            CHANNEL_PERIOD: 0x43,
            CHANNEL_RF_FREQ: 0x45,
            OPEN_CHANNEL: 0x4B,
            CLOSE_CHANNEL: 0x4C,
            BROADCAST_DATA: 0x4E,
            SET_NETWORK_KEY: 0x46,
            RESET_SYSTEM: 0x4A
        };

        // Device Data
        let antStick = null;
        let isConnected = false;
        let broadcastIntervals = {};

        let devices = {
            trainer: {
                active: false,
                paired: false,
                channel: 0,
                deviceId: 12345,
                mode: 'erg',
                power: 0,
                targetPower: 150,
                cadence: 0,
                simulatedCadence: 85,
                speed: 0,
                distance: 0,
                resistance: 0,
                grade: 0,
                inertia: 0,
                powerSmoothing: [],
                lastUpdateTime: 0,
                startTime: null,
                elapsedTime: 0,
                eventCount: 0,
                feState: 0x03,
                dataPageCounter: 0
            },
            shifter: {
                active: false,
                paired: false,
                channel: 1,
                deviceId: 23456,
                currentGear: 6,
                frontChainring: 0, // 0 = big ring (50T), 1 = small ring (34T)
                chainrings: [50, 34],
                cassette: [11, 12, 13, 14, 15, 17, 19, 21, 23, 25, 28, 32],
                eventCount: 0,
                batteryLevel: 85,
                lastShiftTime: 0
            },
            hrm: {
                active: false,
                paired: false,
                channel: 2,
                deviceId: 34567,
                mode: 'manual', // 'manual', 'auto', 'zones'
                heartRate: 85,
                baseHR: 65,
                maxHR: 185,
                targetZone: 2,
                avgHR: 0,
                maxHRSession: 0,
                hrHistory: [],
                eventCount: 0,
                beatTime: 0,
                rr_intervals: []
            }
        };

        // ANT+ Connection Functions
        async function connectANTStick() {
            if (!('serial' in navigator)) {
                alert('Web Serial API not supported. Please use Chrome or Edge browser.');
                return;
            }

            try {
                const port = await navigator.serial.requestPort();
                await port.open({ baudRate: 57600 });

                antStick = port;
                isConnected = true;
                
                updateConnectionStatus(true);
                await initializeANTStick();
                
                log('‚úÖ ANT+ USB stick connected successfully');
                
                // Enable all device pair buttons
                ['trainer', 'shifter', 'hrm'].forEach(device => {
                    document.getElementById(`${device}-pair-btn`).disabled = false;
                });
                
            } catch (error) {
                log(`‚ùå Failed to connect ANT+ stick: ${error.message}`);
                updateConnectionStatus(false);
            }
        }

        async function disconnectANTStick() {
            if (antStick) {
                try {
                    // Stop all active devices
                    Object.keys(devices).forEach(async device => {
                        if (devices[device].active) {
                            await toggleDevice(device, false);
                        }
                    });

                    await antStick.close();
                    antStick = null;
                    isConnected = false;
                    updateConnectionStatus(false);
                    
                    // Disable all controls
                    ['trainer', 'shifter', 'hrm'].forEach(device => {
                        document.getElementById(`${device}-pair-btn`).disabled = true;
                        document.getElementById(`${device}-btn`).disabled = true;
                        devices[device].paired = false;
                        updateDeviceStatus(device, 'inactive');
                    });
                    
                    log('üîå ANT+ USB stick disconnected');
                } catch (error) {
                    log(`‚ùå Disconnect error: ${error.message}`);
                }
            }
        }

        async function initializeANTStick() {
            try {
                await sendANTMessage(ANT_MESSAGE_TYPES.RESET_SYSTEM, []);
                await sleep(500);

                const networkKey = [0xB9, 0xA5, 0x21, 0xFB, 0xBD, 0x72, 0xC3, 0x45];
                await sendANTMessage(ANT_MESSAGE_TYPES.SET_NETWORK_KEY, [0x00, ...networkKey]);
                
                log('üóùÔ∏è ANT+ network key set for all channels');
                
            } catch (error) {
                log(`‚ùå ANT+ initialization failed: ${error.message}`);
            }
        }

        async function sendANTMessage(messageType, data) {
            if (!antStick) return;

            const length = data.length;
            const message = [ANT_SYNC_BYTE, length, messageType, ...data];
            
            let checksum = 0;
            for (let i = 0; i < message.length; i++) {
                checksum ^= message[i];
            }
            message.push(checksum);

            const writer = antStick.writable.getWriter();
            await writer.write(new Uint8Array(message));
            writer.releaseLock();

            const hexMessage = message.map(b => b.toString(16).padStart(2, '0').toUpperCase()).join(' ');
            log(`üì§ TX Ch${data[0] || '?'}: ${hexMessage}`);
        }

        async function setupChannel(deviceType) {
            try {
                const device = devices[deviceType];
                const channel = device.channel;
                let antDeviceType, period;

                switch (deviceType) {
                    case 'trainer':
                        antDeviceType = 0x11; // FE-C
                        period = 8192; // ~4Hz
                        break;
                    case 'shifter':
                        antDeviceType = 0x22; // Shifting
                        period = 8192; // ~4Hz
                        break;
                    case 'hrm':
                        antDeviceType = 0x78; // Heart Rate
                        period = 8070; // ~4Hz
                        break;
                }
                
                // Assign channel
                await sendANTMessage(ANT_MESSAGE_TYPES.ASSIGN_CHANNEL, [channel, 0x10, 0x00]);
                await sleep(50);

                // Set channel ID
                const deviceIdLow = device.deviceId & 0xFF;
                const deviceIdHigh = (device.deviceId >> 8) & 0xFF;
                await sendANTMessage(ANT_MESSAGE_TYPES.CHANNEL_ID, [channel, deviceIdLow, deviceIdHigh, antDeviceType, 0x05]);
                await sleep(50);

                // Set channel period
                const periodLow = period & 0xFF;
                const periodHigh = (period >> 8) & 0xFF;
                await sendANTMessage(ANT_MESSAGE_TYPES.CHANNEL_PERIOD, [channel, periodLow, periodHigh]);
                await sleep(50);

                // Set RF frequency (2457 MHz = 57)
                await sendANTMessage(ANT_MESSAGE_TYPES.CHANNEL_RF_FREQ, [channel, 57]);
                await sleep(50);

                // Open channel
                await sendANTMessage(ANT_MESSAGE_TYPES.OPEN_CHANNEL, [channel]);
                await sleep(50);

                device.paired = true;
                updateDeviceStatus(deviceType, 'paired');
                document.getElementById(`${deviceType}-btn`).disabled = false;
                log(`üì° ${deviceType.toUpperCase()}: Channel ${channel} opened (Device ID: ${device.deviceId})`);

            } catch (error) {
                log(`‚ùå ${deviceType.toUpperCase()}: Channel setup failed - ${error.message}`);
            }
        }

        // Device Control Functions
        async function pairTrainer() {
            updateDeviceStatus('trainer', 'pairing');
            await setupChannel('trainer');
        }

        async function pairShifter() {
            updateDeviceStatus('shifter', 'pairing');
            await setupChannel('shifter');
            updateShifterDisplay();
        }

        async function pairHRM() {
            updateDeviceStatus('hrm', 'pairing');
            await setupChannel('hrm');
        }

        async function toggleTrainer() {
            await toggleDevice('trainer', !devices.trainer.active);
        }

        async function toggleShifter() {
            await toggleDevice('shifter', !devices.shifter.active);
        }

        async function toggleHRM() {
            await toggleDevice('hrm', !devices.hrm.active);
        }

        async function toggleDevice(deviceType, start) {
            const device = devices[deviceType];
            const btn = document.getElementById(`${deviceType}-btn`);
            
            if (start && !device.active) {
                device.active = true;
                device.startTime = Date.now();
                device.lastUpdateTime = Date.now();
                device.eventCount = 0;
                
                if (deviceType === 'trainer') {
                    device.distance = 0;
                    device.powerSmoothing = [];
                } else if (deviceType === 'hrm') {
                    device.hrHistory = [];
                    device.maxHRSession = 0;
                    device.beatTime = Date.now();
                }
                
                btn.textContent = 'Stop Broadcasting';
                btn.className = 'btn btn-stop';
                updateDeviceStatus(deviceType, 'active');
                log(`üì° ${deviceType.toUpperCase()}: Broadcasting started`);
                
                startBroadcasting(deviceType);
                
            } else if (!start && device.active) {
                device.active = false;
                clearInterval(broadcastIntervals[deviceType]);
                
                btn.textContent = 'Start Broadcasting';
                btn.className = 'btn';
                updateDeviceStatus(deviceType, 'paired');
                log(`üì° ${deviceType.toUpperCase()}: Broadcasting stopped`);
            }
        }

        function startBroadcasting(deviceType) {
            const broadcastRate = deviceType === 'hrm' ? 1000 : 250; // HRM at 1Hz, others at 4Hz
            
            broadcastIntervals[deviceType] = setInterval(async () => {
                updateDeviceSimulation(deviceType);
                await broadcastDeviceData(deviceType);
                updateDeviceUI(deviceType);
            }, broadcastRate);
        }

        function updateDeviceSimulation(deviceType) {
            const device = devices[deviceType];
            const currentTime = Date.now();
            const deltaTime = (currentTime - device.lastUpdateTime) / 1000;
            device.lastUpdateTime = currentTime;
            device.elapsedTime = currentTime - device.startTime;

            switch (deviceType) {
                case 'trainer':
                    updateTrainerSimulation(device, deltaTime);
                    break;
                case 'shifter':
                    updateShifterSimulation(device);
                    break;
                case 'hrm':
                    updateHRMSimulation(device);
                    break;
            }

            device.eventCount = (device.eventCount + 1) % 256;
        }

        function updateTrainerSimulation(device, deltaTime) {
            const simulatedCadence = parseInt(document.getElementById('simulated-cadence').value) || 0;
            device.cadence = simulatedCadence;

            let targetPower = 0;
            switch (device.mode) {
                case 'erg':
                    targetPower = device.targetPower;
                    device.power = smoothPower(targetPower + (Math.random() - 0.5) * 10, device);
                    break;
                case 'resistance':
                    const resistanceFactor = device.resistance / 100;
                    targetPower = Math.pow(simulatedCadence / 90, 2) * (100 + resistanceFactor * 200);
                    device.power = smoothPower(targetPower + (Math.random() - 0.5) * 15, device);
                    break;
                case 'simulation':
                    const basePower = Math.pow(simulatedCadence / 90, 2) * 150;
                    const gradePower = device.grade * 75 * 0.2; // Assuming 75kg rider
                    targetPower = Math.max(0, basePower + gradePower);
                    device.power = smoothPower(targetPower + (Math.random() - 0.5) * 20, device);
                    break;
            }

            if (simulatedCadence > 0) {
                device.speed = Math.max(0, (device.power / 12) + (simulatedCadence * 0.1) + (Math.random() - 0.5) * 2);
            } else {
                device.speed = 0;
            }

            device.distance += device.speed * deltaTime / 3600;
        }

        function updateShifterSimulation(device) {
            // Shifter doesn't need continuous simulation, just responds to shift events
            // Update battery level slowly over time
            if (Math.random() < 0.001) { // Very rarely decrease battery
                device.batteryLevel = Math.max(0, device.batteryLevel - 1);
            }
        }

        function updateHRMSimulation(device) {
            switch (device.mode) {
                case 'manual':
                    device.heartRate = parseInt(document.getElementById('manual-hr').value) || 85;
                    break;
                case 'auto':
                    // Simulate HR based on trainer power if available
                    let targetHR = device.baseHR;
                    if (devices.trainer.active && devices.trainer.power > 0) {
                        const powerPercent = Math.min(devices.trainer.power / 300, 1);
                        targetHR = device.baseHR + (device.maxHR - device.baseHR) * powerPercent;
                    }
                    device.heartRate = Math.max(40, targetHR + (Math.random() - 0.5) * 8);
                    break;
                case 'zones':
                    const zones = [
                        { min: 0.50, max: 0.60 }, // Zone 1
                        { min: 0.60, max: 0.70 }, // Zone 2
                        { min: 0.70, max: 0.80 }, // Zone 3
                        { min: 0.80, max: 0.90 }, // Zone 4
                        { min: 0.90, max: 1.00 }  // Zone 5
                    ];
                    const zone = zones[device.targetZone - 1];
                    const targetPercent = (zone.min + zone.max) / 2;
                    const targetZoneHR = device.maxHR * targetPercent;
                    device.heartRate = Math.max(40, targetZoneHR + (Math.random() - 0.5) * 10);
                    break;
            }

            // Update HR history and stats
            device.hrHistory.push(device.heartRate);
            if (device.hrHistory.length > 60) { // Keep last 60 seconds
                device.hrHistory.shift();
            }
            device.avgHR = device.hrHistory.reduce((a, b) => a + b, 0) / device.hrHistory.length;
            device.maxHRSession = Math.max(device.maxHRSession, device.heartRate);

            // Simulate RR intervals for advanced HRM features
            const rrInterval = 60000 / device.heartRate; // ms between beats
            device.rr_intervals.push(rrInterval + (Math.random() - 0.5) * 20);
            if (device.rr_intervals.length > 16) {
                device.rr_intervals.shift();
            }
        }

        function smoothPower(newPower, device) {
            device.powerSmoothing.push(newPower);
            if (device.powerSmoothing.length > 8) {
                device.powerSmoothing.shift();
            }
            return device.powerSmoothing.reduce((a, b) => a + b, 0) / device.powerSmoothing.length;
        }

        async function broadcastDeviceData(deviceType) {
            const device = devices[deviceType];
            let payload = [];

            switch (deviceType) {
                case 'trainer':
                    payload = createTrainerPayload(device);
                    break;
                case 'shifter':
                    payload = createShifterPayload(device);
                    break;
                case 'hrm':
                    payload = createHRMPayload(device);
                    break;
            }

            await sendANTMessage(ANT_MESSAGE_TYPES.BROADCAST_DATA, [device.channel, ...payload]);
        }

        function createTrainerPayload(device) {
            device.dataPageCounter = (device.dataPageCounter + 1) % 16;
            
            switch (device.dataPageCounter) {
                case 0:
                case 4:
                case 8:
                case 12:
                    // General FE Data (Page 0x10)
                    const elapsedTime25 = Math.floor(device.elapsedTime / 250) % 256;
                    const distanceM = Math.floor(device.distance * 1000) % 256;
                    
                    return [
                        0x10, // Page 0x10
                        0x19, // Equipment type (trainer)
                        elapsedTime25,
                        distanceM,
                        Math.round(device.speed * 100) & 0xFF,
                        (Math.round(device.speed * 100) >> 8) & 0xFF,
                        Math.round(device.heartRate || 0),
                        device.feState
                    ];
                    
                case 1:
                    // Specific Trainer Data (Page 0x19)
                    const instantPower = Math.round(device.power);
                    return [
                        0x19, // Page 0x19
                        device.eventCount,
                        Math.round(device.cadence),
                        0xFF,
                        0xFF,
                        instantPower & 0xFF,
                        (instantPower >> 8) & 0x0F | 0x10,
                        0x00
                    ];
                    
                default:
                    // Manufacturer info
                    return [
                        0x50, // Page 0x50
                        0xFF, 0xFF,
                        0x01, // HW revision
                        0x20, 0x00, // Wahoo Fitness
                        0x09, 0x01  // KICKR CORE
                    ];
            }
        }

        function createShifterPayload(device) {
            const frontGear = device.chainrings[device.frontChainring];
            const rearGear = device.cassette[device.currentGear - 1];
            
            return [
                0x22, // Shifting data page
                device.eventCount,
                device.currentGear, // Current gear position
                frontGear, // Front chainring teeth
                rearGear, // Rear cog teeth
                device.batteryLevel, // Battery level
                0x00, // Status flags
                device.frontChainring // Front derailleur position
            ];
        }

        function createHRMPayload(device) {
            // Update beat event count based on heart rate
            const currentTime = Date.now();
            if (currentTime - device.beatTime > (60000 / Math.max(device.heartRate, 1))) {
                device.eventCount++;
                device.beatTime = currentTime;
            }
            
            return [
                0x00, // Heart rate data page
                0xFF, 0xFF, 0xFF, // Reserved
                device.eventCount & 0xFF,
                (device.eventCount >> 8) & 0xFF,
                Math.round(device.heartRate) & 0xFF,
                0x00 // Reserved
            ];
        }

        function updateDeviceUI(deviceType) {
            switch (deviceType) {
                case 'trainer':
                    updateTrainerUI();
                    break;
                case 'shifter':
                    // Shifter UI updates are handled by shift events
                    break;
                case 'hrm':
                    updateHRMUI();
                    break;
            }
        }

        function updateTrainerUI() {
            const device = devices.trainer;
            
            // Animate metrics
            ['power', 'cadence', 'speed', 'resistance'].forEach(metric => {
                const element = document.getElementById(`${metric}-metric`);
                element.classList.add('updated');
                setTimeout(() => element.classList.remove('updated'), 200);
            });

            document.getElementById('power-value').textContent = Math.round(device.power);
            document.getElementById('cadence-value').textContent = Math.round(device.cadence);
            document.getElementById('speed-value').textContent = device.speed.toFixed(1);
            document.getElementById('resistance-value').textContent = device.resistance;
            document.getElementById('distance-value').textContent = device.distance.toFixed(2);
            document.getElementById('time-value').textContent = formatTime(device.elapsedTime);
        }

        function updateHRMUI() {
            const device = devices.hrm;
            
            document.getElementById('hr-metric').classList.add('updated');
            setTimeout(() => document.getElementById('hr-metric').classList.remove('updated'), 200);
            
            document.getElementById('hr-value').textContent = Math.round(device.heartRate);
            document.getElementById('hr-avg').textContent = Math.round(device.avgHR);
            document.getElementById('hr-max').textContent = Math.round(device.maxHRSession);
            
            updateHRZone(device.heartRate, device.maxHR);
        }

        // Control Functions
        function setTrainerMode(mode) {
            devices.trainer.mode = mode;
            
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`${mode}-mode`).classList.add('active');
            
            document.getElementById('erg-controls').style.display = mode === 'erg' ? 'block' : 'none';
            document.getElementById('resistance-controls').style.display = mode === 'resistance' ? 'block' : 'none';
            document.getElementById('simulation-controls').style.display = mode === 'simulation' ? 'block' : 'none';
            
            log(`üéØ Trainer mode: ${mode.toUpperCase()}`);
        }

        function setHRMode(mode) {
            devices.hrm.mode = mode;
            
            document.querySelectorAll('#hrm .mode-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`hr-${mode}-mode`).classList.add('active');
            
            document.getElementById('hr-manual-controls').style.display = mode === 'manual' ? 'block' : 'none';
            document.getElementById('hr-auto-controls').style.display = mode === 'auto' ? 'block' : 'none';
            document.getElementById('hr-zones-controls').style.display = mode === 'zones' ? 'block' : 'none';
            
            log(`‚ù§Ô∏è HR mode: ${mode.toUpperCase()}`);
        }

        function updateTargetPower() {
            devices.trainer.targetPower = parseInt(document.getElementById('target-power').value) || 150;
            log(`üéØ Target power: ${devices.trainer.targetPower}W`);
        }

        function updateResistance() {
            devices.trainer.resistance = parseInt(document.getElementById('resistance-slider').value || 0);
            log(`üéõÔ∏è Resistance: ${devices.trainer.resistance}%`);
        }

        function adjustResistance(change) {
            const newValue = Math.max(0, Math.min(100, devices.trainer.resistance + change));
            devices.trainer.resistance = newValue;
            document.getElementById('resistance-slider').value = newValue;
            log(`üéõÔ∏è Resistance adjusted: ${newValue}%`);
        }

        function updateGrade() {
            devices.trainer.grade = parseFloat(document.getElementById('grade-input').value) || 0;
            log(`üèîÔ∏è Grade: ${devices.trainer.grade}%`);
        }

        function updateCadence() {
            devices.trainer.simulatedCadence = parseInt(document.getElementById('simulated-cadence').value) || 85;
            log(`üîÑ Cadence: ${devices.trainer.simulatedCadence} RPM`);
        }

        function updateManualHR() {
            devices.hrm.heartRate = parseInt(document.getElementById('manual-hr').value) || 85;
            log(`‚ù§Ô∏è Manual HR: ${devices.hrm.heartRate} BPM`);
        }

        function updateBaseHR() {
            devices.hrm.baseHR = parseInt(document.getElementById('base-hr').value) || 65;
            log(`‚ù§Ô∏è Base HR: ${devices.hrm.baseHR} BPM`);
        }

        function updateMaxHR() {
            devices.hrm.maxHR = parseInt(document.getElementById('max-hr-input').value) || 185;
            log(`‚ù§Ô∏è Max HR: ${devices.hrm.maxHR} BPM`);
        }

        function updateTargetZone() {
            devices.hrm.targetZone = parseInt(document.getElementById('target-zone').value) || 2;
            log(`‚ù§Ô∏è Target zone: ${devices.hrm.targetZone}`);
        }

        function updateChainrings() {
            const chainringsText = document.getElementById('chainrings').value;
            devices.shifter.chainrings = chainringsText.split(',').map(t => parseInt(t.trim()));
            updateShifterDisplay();
            log(`‚öôÔ∏è Chainrings updated: ${devices.shifter.chainrings.join(', ')}`);
        }

        function updateCassette() {
            const cassetteText = document.getElementById('cassette').value;
            devices.shifter.cassette = cassetteText.split(',').map(t => parseInt(t.trim()));
            updateShifterDisplay();
            log(`‚öôÔ∏è Cassette updated: ${devices.shifter.cassette.join(', ')}`);
        }

        async function shiftUp() {
            const device = devices.shifter;
            if (device.currentGear < device.cassette.length) {
                device.currentGear++;
                device.lastShiftTime = Date.now();
                updateShifterDisplay();
                
                if (device.active) {
                    await broadcastDeviceData('shifter');
                }
                
                log(`‚öôÔ∏è Shift UP: Gear ${device.currentGear}`);
            }
        }

        async function shiftDown() {
            const device = devices.shifter;
            if (device.currentGear > 1) {
                device.currentGear--;
                device.lastShiftTime = Date.now();
                updateShifterDisplay();
                
                if (device.active) {
                    await broadcastDeviceData('shifter');
                }
                
                log(`‚öôÔ∏è Shift DOWN: Gear ${device.currentGear}`);
            }
        }

        function updateShifterDisplay() {
            const device = devices.shifter;
            const frontGear = device.chainrings[device.frontChainring];
            const rearGear = device.cassette[device.currentGear - 1];
            const ratio = (frontGear / rearGear).toFixed(2);
            
            const gearDisplay = document.getElementById('gear-display');
            gearDisplay.textContent = device.currentGear;
            gearDisplay.classList.add('updated');
            setTimeout(() => gearDisplay.classList.remove('updated'), 300);
            
            document.getElementById('front-gear').textContent = frontGear;
            document.getElementById('rear-gear').textContent = rearGear;
            document.getElementById('gear-ratio').textContent = ratio;
            
            // Update cassette display
            const cassetteDisplay = document.getElementById('cassette-display');
            cassetteDisplay.innerHTML = '';
            device.cassette.forEach((teeth, index) => {
                const gear = document.createElement('div');
                gear.className = 'cassette-gear';
                if (index === device.currentGear - 1) {
                    gear.classList.add('active');
                }
                gear.textContent = teeth;
                cassetteDisplay.appendChild(gear);
            });
        }

        function updateHRZone(heartRate, maxHR) {
            const zoneElement = document.getElementById('hr-zone');
            
            const zones = [
                { max: 0.6, name: 'Zone 1 - Recovery', class: 'zone-1' },
                { max: 0.7, name: 'Zone 2 - Aerobic Base', class: 'zone-2' },
                { max: 0.8, name: 'Zone 3 - Aerobic', class: 'zone-3' },
                { max: 0.9, name: 'Zone 4 - Threshold', class: 'zone-4' },
                { max: 1.0, name: 'Zone 5 - VO2 Max', class: 'zone-5' }
            ];
            
            const hrPercent = heartRate / maxHR;
            let currentZone = zones[zones.length - 1];
            
            for (let zone of zones) {
                if (hrPercent <= zone.max) {
                    currentZone = zone;
                    break;
                }
            }
            
            zoneElement.textContent = currentZone.name;
            zoneElement.className = `hr-zone ${currentZone.class}`;
        }

        function updateConnectionStatus(connected) {
            const statusDot = document.getElementById('usb-status-dot');
            const statusText = document.getElementById('usb-status-text');
            const connectBtn = document.getElementById('connect-btn');
            const antInfo = document.getElementById('ant-stick-info');

            if (connected) {
                statusDot.classList.add('connected');
                statusText.textContent = 'ANT+ USB Stick: Connected';
                connectBtn.textContent = 'Disconnect';
                connectBtn.onclick = disconnectANTStick;
                antInfo.style.display = 'block';
            } else {
                statusDot.classList.remove('connected');
                statusText.textContent = 'ANT+ USB Stick: Disconnected';
                connectBtn.textContent = 'Connect ANT+ USB';
                connectBtn.onclick = connectANTStick;
                antInfo.style.display = 'none';
            }
        }

        function updateDeviceStatus(deviceType, status) {
            const statusIndicator = document.getElementById(`${deviceType}-status`);
            const statusText = document.getElementById(`${deviceType}-status-text`);
            
            switch (status) {
                case 'active':
                    statusIndicator.className = 'status-indicator status-active';
                    statusText.textContent = 'Broadcasting';
                    break;
                case 'paired':
                    statusIndicator.className = 'status-indicator status-active';
                    statusText.textContent = 'Paired';
                    break;
                case 'pairing':
                    statusIndicator.className = 'status-indicator status-pairing';
                    statusText.textContent = 'Pairing...';
                    break;
                case 'inactive':
                default:
                    statusIndicator.className = 'status-indicator status-inactive';
                    statusText.textContent = 'Stopped';
                    break;
            }
        }

        // Utility Functions
        function formatTime(milliseconds) {
            const totalSeconds = Math.floor(milliseconds / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function log(message) {
            const logContent = document.getElementById('log-content');
            const timestamp = new Date().toLocaleTimeString();
            logContent.textContent += `[${timestamp}] ${message}\n`;
            logContent.scrollTop = logContent.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log-content').textContent = '';
        }

        // Initialize Application
        function initializeApp() {
            updateConnectionStatus(false);
            ['trainer', 'shifter', 'hrm'].forEach(device => {
                updateDeviceStatus(device, 'inactive');
            });
            
            // Initialize shifter display
            updateShifterDisplay();
            
            // Set default HR zone
            updateHRZone(85, 185);
            
            log('üöÄ Multi-Device ANT+ Emulator Suite initialized');
            log('üì± Connect ANT+ USB stick to begin broadcasting');
            log('üîß Three devices ready: Kickr Core (FE-C), Zwift Click (Shifting), HRM');
            
            // Check for Web Serial API support
            if (!('serial' in navigator)) {
                log('‚ö†Ô∏è Web Serial API not supported. Please use Chrome or Edge browser.');
            } else {
                log('‚úÖ Web Serial API supported - ready for ANT+ connection');
            }
        }

        // Keyboard Shortcuts
        document.addEventListener('keydown', function(event) {
            // Only if no input is focused
            if (document.activeElement.tagName.toLowerCase() !== 'input' && 
                document.activeElement.tagName.toLowerCase() !== 'select') {
                
                switch (event.key) {
                    case 'ArrowUp':
                        event.preventDefault();
                        if (devices.shifter.paired) {
                            shiftUp();
                        }
                        break;
                    case 'ArrowDown':
                        event.preventDefault();
                        if (devices.shifter.paired) {
                            shiftDown();
                        }
                        break;
                    case ' ':
                        event.preventDefault();
                        // Toggle trainer if paired
                        if (devices.trainer.paired) {
                            toggleTrainer();
                        }
                        break;
                }
            }
        });

        // Auto-update resistance slider
        document.getElementById('resistance-slider').addEventListener('input', function() {
            devices.trainer.resistance = parseInt(this.value);
            document.getElementById('resistance-value').textContent = devices.trainer.resistance;
        });

        // Auto-update manual HR
        document.getElementById('manual-hr').addEventListener('input', function() {
            if (devices.hrm.mode === 'manual') {
                devices.hrm.heartRate = parseInt(this.value) || 85;
            }
        });

        // Initialize the application
        initializeApp();

        // Add helpful tips to log
        setTimeout(() => {
            log('üí° Tips:');
            log('   ‚Ä¢ Use ‚Üë/‚Üì arrow keys to shift gears when Zwift Click is paired');
            log('   ‚Ä¢ Press SPACE to start/stop trainer when paired');
            log('   ‚Ä¢ HR Monitor can sync with trainer power in Auto mode');
            log('   ‚Ä¢ All three devices can broadcast simultaneously');
        }, 1000);
    </script>
</body>
</html>
